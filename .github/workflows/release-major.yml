name: release-major-minor

on:
  push:
    branches: [main]
    paths:
      - package.json
      - package-lock.json
      - .github/workflows/release-major.yml
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect release condition
        id: version
        env:
          BEFORE_SHA: ${{ github.event.before }}
          GH_REPOSITORY: ${{ github.repository }}
          GH_TOKEN: ${{ github.token }}
        run: |
          node <<'NODE'
          const fs = require('node:fs');
          const { execSync } = require('node:child_process');

          const outputPath = process.env.GITHUB_OUTPUT;
          let beforeSha = process.env.BEFORE_SHA || '';
          const currentVersion = JSON.parse(fs.readFileSync('package.json', 'utf8')).version;

          const parseVersion = (value) => {
            const match = String(value).trim().match(/^(\d+)\.(\d+)\.(\d+)(?:[-+].*)?$/);
            if (!match) return null;
            return {
              major: Number(match[1]),
              minor: Number(match[2]),
              patch: Number(match[3])
            };
          };

          let previousVersion = null;
          if (!beforeSha || /^0+$/.test(beforeSha)) {
            try {
              beforeSha = execSync('git rev-parse HEAD^', { encoding: 'utf8' }).trim();
            } catch (error) {
              beforeSha = '';
            }
          }
          if (beforeSha && !/^0+$/.test(beforeSha)) {
            try {
              const previousRaw = execSync(`git show ${beforeSha}:package.json`, {
                encoding: 'utf8',
                stdio: ['ignore', 'pipe', 'ignore']
              });
              previousVersion = JSON.parse(previousRaw).version;
            } catch (error) {
              previousVersion = null;
            }
          }

          const current = parseVersion(currentVersion);
          const previous = previousVersion ? parseVersion(previousVersion) : null;
          const tag = `v${currentVersion}`;
          const tagExists = (() => {
            try {
              const existing = execSync(`git tag --list "${tag}"`, { encoding: 'utf8' }).trim();
              return existing === tag;
            } catch (error) {
              return false;
            }
          })();
          const releaseExists = (() => {
            try {
              const repo = process.env.GH_REPOSITORY;
              const token = process.env.GH_TOKEN;
              if (!repo || !token) return false;
              const cmd =
                'curl -s -o /dev/null -w "%{http_code}" ' +
                `-H "Authorization: Bearer ${token}" ` +
                '-H "Accept: application/vnd.github+json" ' +
                `https://api.github.com/repos/${repo}/releases/tags/${tag}`;
              const status = execSync(cmd, { encoding: 'utf8' }).trim();
              return status === '200';
            } catch (error) {
              return false;
            }
          })();

          let releaseBumped = false;
          let bumpKind = '';
          if (current && previous) {
            if (current.major > previous.major) {
              releaseBumped = true;
              bumpKind = 'major';
            } else if (current.major === previous.major && current.minor > previous.minor) {
              releaseBumped = true;
              bumpKind = 'minor';
            }
          }
          const releaseNeeded = releaseBumped || !tagExists || !releaseExists;

          const lines = [
            `current_version=${currentVersion}`,
            `previous_version=${previousVersion ?? ''}`,
            `current_major=${current?.major ?? ''}`,
            `previous_major=${previous?.major ?? ''}`,
            `current_minor=${current?.minor ?? ''}`,
            `previous_minor=${previous?.minor ?? ''}`,
            `release_bumped=${releaseBumped ? 'true' : 'false'}`,
            `release_needed=${releaseNeeded ? 'true' : 'false'}`,
            `tag_exists=${tagExists ? 'true' : 'false'}`,
            `release_exists=${releaseExists ? 'true' : 'false'}`,
            `bump_kind=${bumpKind}`,
            `tag=${tag}`
          ];
          fs.appendFileSync(outputPath, `${lines.join('\n')}\n`);

          console.log(
            `current=${currentVersion} previous=${previousVersion ?? 'unknown'} release_bumped=${releaseBumped} tag_exists=${tagExists} release_exists=${releaseExists} release_needed=${releaseNeeded} kind=${bumpKind || 'none'}`
          );
          NODE

      - name: Skip when release is unnecessary
        if: steps.version.outputs.release_needed != 'true'
        run: echo "No major/minor bump and release already exists. Skipping release."

      - name: Setup Node
        if: steps.version.outputs.release_needed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        if: steps.version.outputs.release_needed == 'true'
        run: npm ci

      - name: Build
        if: steps.version.outputs.release_needed == 'true'
        run: npm run build

      - name: Create GitHub Release
        if: steps.version.outputs.release_needed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          target_commitish: ${{ github.sha }}
          name: ${{ steps.version.outputs.tag }}
          generate_release_notes: true
          make_latest: true
          files: |
            dist/bbmcp.js
            dist/bbmcp.js.map
            dist/bbmcp-sidecar.js
            dist/bbmcp-sidecar.js.map
          overwrite_files: true
